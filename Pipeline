Download FASTQ sequences from ncbi

Run FASTOC or Falco: qulity control

Split files for running trimmomatic
     Code: fasterq-dump --split-files SRR.....
     Input: SRR....fastq files
     Output: SRR...R1.fastq    SRR...R2.fastq

Run fastqc for quality check and adaptor contamination for each separate files
     Download fastqc: babraham bioinformatics

Trimming the adaptor sequences
     Download trimmomatic: github
     Code: java -jar /mnt/d/gaurgram/Trimmomatic-0.39/trimmomatic-0.39.jar PE -threads 6 \
           control_R1_rep1.fastq  control_R2_rep1.fastq \
           control_R1_rep1_paired.fastq control_R1_rep1_unpaired.fastq \
           control_R2_rep1_paired.fastq control_R2_rep1_unpaired.fastq \
           ILLUMINACLIP:/mnt/d/gaurgram/Trimmomatic-0.39/adapters/TruSeq3-PE.fa:2:30:10 \
           LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:36
     Input: forward and reverse R1/R2 files
     Output: paired and unpaired R1/R2 files

Index the ref genome
     Code: hisat2-build ref_genome.fa index_prefix [No gtf file is avaliable for Cyamopsis tetragonoloba] 

Align the samples with indexed ref genome
     Code: hisat2 -p 4 --dta -x index_prefix \
          -1 control_R1_rep2.fastq -2 control_R2_rep2.fastq \
           | samtools sort -o control_rep2.sorted.bam
     [Instead of converting to .sam file convert directly to bam file using samtools]
     Input: R1/R2 fastq files
     Output: sorted.bam file

Quantifiy Gene Expression
     Each sample has 3 biological replicates, run sorted.bam files in a single run
     Code: featureCounts -T 4 \
          -p -B -C \
          -t exon \
          -g gene_id \
          --tmpDir /tmp \
          -a merged.gtf \
          -o feature_counts.txt \
          control_rep1.sorted.bam control_rep2.sorted.bam control_rep3.sorted.bam \
          heat_rep1.sorted.bam heat_rep2.sorted.bam heat_rep3.sorted.bam \
          drought_rep1.sorted.bam drought_rep2.sorted.bam drought_rep3.sorted.bam \
          salinity_rep1.sorted.bam salinity_rep2.sorted.bam salinity_rep3.sorted.bam

R
Read Count Matrix 
Code: counts <- read.table(
      "gene_counts_matrix.txt",
      header = TRUE,
      row.names = 1,
      sep = "\t",
      check.names = FALSE
      )

Check sample names
Code: colnames(counts)

Create Coldata/Metadata
Code: colData <- data.frame(
  condition = c(
    "control","control","control",
    "heat","heat","heat",
    "drought","drought","drought",
    "salinity","salinity","salinity"
  )
)

row.names(colData) <- colnames(counts)

Check if the coloumn name of count_matrix match the row names of coldata
Code: all(rownames(colData) == colnames(counts))

Save Coldata
Code: write.table(colData, "colData.txt", sep="\t", quote=FALSE)

Load Libraries
Code: install.packages("BiocManager"); BiocManager::install("DESeq2"))
      library(DESeq2)

Load feature_count.txt file 
Code: counts <- read.delim(
      "feature_counts.txt",
      comment.char = "#",
      row.names = 1
      )

Laod coldata
Code: coldata <- read.csv("coldata.csv", row.names = 1)
# remove annotation columns (Chr, Start, End, Strand, Length)

DEG ANALYSIS
Create DESeq2 Dataset 
Code: dds <- DESeqDataSetFromMatrix(
      countData = countdata,
      colData = coldata,
      design = ~ condition
      )
      dds <- dds[rowSums(counts(dds)) > 10, ]       #to remove low counts

Control vs Heat
Code: res_heat <- results(dds, contrast = c("condition", "heat", "control"))
      res_heat_df <- as.data.frame(res_heat)
      res_heat_df <- res_heat_df[order(res_heat_df$padj), ]
      deg_heat <- subset(
      res_heat_df,
      padj < 0.05 & abs(log2FoldChange) >= 1
      )
     write.csv(deg_heat, file = "DEG_heat_vs_control.csv") - to save the file in csv

Reapeat the same for "Control vs Drought and Control vs Salinity" and save the files
Code: res_drought <- results(dds, contrast = c("condition", "drought", "control"))
      res_salinity <- results(dds, contrast = c("condition", "salinity", "control"))

Normalization
Variance Stabilizing Transformation (VST)

   Extract normalized counts and perform VST
   Code: vsd <- vst(dds, blind = FALSE)
         vst_mat <- assay(vsd)
         head(vst_mat)
         write.csv(vst_mat, "vst_normalized_counts.csv")

Visualization

PCA plot: to sample clustering
Code: pcaData <- plotPCA(vsd, intgroup = "condition", returnData = TRUE)
      percentVar <- round(100 * attr(pcaData, "percentVar"))
      
library(ggplot2)

ggplot(pcaData, aes(x = PC1, y = PC2, color = condition)) +
  geom_point(size = 4) +
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +
  theme_bw() +
  theme(
    text = element_text(size = 14),
    legend.title = element_blank()
  )

Volcano plot
Volcano_drought
code: TO have files: res_drought
                     res_heat
                     res_salinity

#Convert DESeq2 to data frame
res_df <- as.data.frame(res_drought)
res_df$gene <- rownames(res_df)

#Remove NA values
res_df <- res_df[!is.na(res_df$padj), ]

#Define thresholds
log2FC_cutoff <- 1
padj_cutoff <- 0.05

#Classify genes (Up / Down / Not significant)
res_df$diffexpressed <- "Not Significant"

res_df$diffexpressed[
  res_df$log2FoldChange >= log2FC_cutoff & res_df$padj < padj_cutoff
] <- "Up"

res_df$diffexpressed[
  res_df$log2FoldChange <= -log2FC_cutoff & res_df$padj < padj_cutoff
] <- "Down"

#drought_vs_control
library(ggplot2)

ggplot(res_df, aes(x = log2FoldChange, y = -log10(padj), color = diffexpressed)) +
  geom_point(alpha = 0.6, size = 1.5) +
  scale_color_manual(values = c(
    "Up" = "#E64B35",
    "Down" = "#4DBBD5",
    "Not Significant" = "grey"
  )) +
  geom_vline(xintercept = c(-log2FC_cutoff, log2FC_cutoff), linetype = "dashed") +
  geom_hline(yintercept = -log10(padj_cutoff), linetype = "dashed") +
  theme_bw() +
  labs(
    title = "Volcano plot: Drought vs Control",
    x = "log2 Fold Change",
    y = "-log10 adjusted p-value",
    color = "Expression"
  )

#save the plot
ggsave("volcano_drought_vs_control.png", width = 7, height = 6, dpi = 300)

Volcano_heat & volcano_salinity

prepare_volcano_df <- function(res, lfc = 1, padj_cut = 0.05) {
  df <- as.data.frame(res)
  df$gene <- rownames(df)
  df <- df[!is.na(df$padj), ]

  df$status <- "Not Significant"
  df$status[df$log2FoldChange >= lfc & df$padj < padj_cut] <- "Up"
  df$status[df$log2FoldChange <= -lfc & df$padj < padj_cut] <- "Down"

  return(df)
}

#prepare data for heat and salinity
heat_df <- prepare_volcano_df(res_heat)
salinity_df <- prepare_volcano_df(res_salinity)

#heat_vs_control
library(ggplot2)

volcano_heat <- ggplot(heat_df, aes(log2FoldChange, -log10(padj), color = status)) +
  geom_point(alpha = 0.6, size = 1.5) +
  scale_color_manual(values = c(
    "Up" = "#D73027",
    "Down" = "#4575B4",
    "Not Significant" = "grey70"
  )) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  theme_bw() +
  labs(
    title = "Heat vs Control",
    x = "log2 Fold Change",
    y = "-log10 adjusted p-value",
    color = "Expression"
  )

#volcano_heat
library(ggplot2)

volcano_heat <- ggplot(heat_df, aes(log2FoldChange, -log10(padj), color = status)) +
  geom_point(alpha = 0.6, size = 1.5) +
  scale_color_manual(values = c(
    "Up" = "#D73027",
    "Down" = "#4575B4",
    "Not Significant" = "grey70"
  )) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  theme_bw() +
  labs(
    title = "Heat vs Control",
    x = "log2 Fold Change",
    y = "-log10 adjusted p-value",
    color = "Expression"
  )

volcano_heat

#salinity_vs_control
volcano_salinity <- ggplot(salinity_df, aes(log2FoldChange, -log10(padj), color = status)) +
  geom_point(alpha = 0.6, size = 1.5) +
  scale_color_manual(values = c(
    "Up" = "#762A83",
    "Down" = "#1B7837",
    "Not Significant" = "grey70"
  )) +
  geom_vline(xintercept = c(-1, 1), linetype = "dashed") +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  theme_bw() +
  labs(
    title = "Salinity vs Control",
    x = "log2 Fold Change",
    y = "-log10 adjusted p-value",
    color = "Expression"
  )

volcano_salinity

#save plots
ggsave("volcano_heat_vs_control.png", volcano_heat, width = 7, height = 6, dpi = 300)
ggsave("volcano_salinity_vs_control.png", volcano_salinity, width = 7, height = 6, dpi = 300)

Heatmap 
To generate heatmap of significantly DE in ALL three stresses

get_sig_genes <- function(res, padj_cut = 0.05, lfc_cut = 1) {
  df <- as.data.frame(res)
  df <- df[!is.na(df$padj), ]
  rownames(df)[df$padj < padj_cut & abs(df$log2FoldChange) > lfc_cut]
}
genes_drought  <- get_sig_genes(res_drought)
genes_heat     <- get_sig_genes(res_heat)
genes_salinity <- get_sig_genes(res_salinity)

#to check counts
length(genes_drought)
length(genes_heat)
length(genes_salinity)

#to find shared DEG's
shared_genes <- Reduce(intersect, list(
  genes_drought,
  genes_heat,
  genes_salinity
))

#check no of shared genes
length(shared_genes) - 96

#annotation of samples and add colours
annotation_col <- data.frame(
  condition = colData(dds)$condition
)

rownames(annotation_col) <- colnames(heatmap_mat)
ann_colors <- list(
  condition = c(
    control = "#4DAF4A",
    heat = "#E41A1C",
    drought = "#FF7F00",
    salinity = "#377EB8"
  )
)

#To plot Heatmap
library(pheatmap)

pheatmap(
  heatmap_mat,
  annotation_col = annotation_col,
  annotation_colors = ann_colors,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  show_rownames = FALSE,
  fontsize_col = 8,
  color = colorRampPalette(c("navy", "white", "firebrick3"))(100),
  main = "Shared Differentially Expressed Genes Across Stresses"
)

#save file in pdf
pdf("shared_DEG_heatmap.pdf", width = 10, height = 12)
pheatmap(
  heatmap_mat,
  annotation_col = annotation_col,
  annotation_colors = ann_colors,
  show_rownames = FALSE,
  color = colorRampPalette(c("navy", "white", "firebrick3"))(100)
)
dev.off()

MA plot
For each stress sample

Drought vs Control
Code: plotMA(
  res_drought,
  ylim = c(-5, 5),
  main = "MA plot: Drought vs Control"
)

Heat vs Control
plotMA(
  res_heat,
  ylim = c(-5, 5),
  main = "MA plot: Heat vs Control"
)

Salinity vs Control
plotMA(
  res_salinity,
  ylim = c(-5, 5),
  main = "MA plot: Salinity vs Control"
)

For combining all the plots
combined_MA <- ma_plot_drought | ma_plot_heat | ma_plot_salinity
combined_MA






